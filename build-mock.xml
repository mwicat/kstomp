<?xml version="1.0" ?>
<project name="amxm-test" default="report">

	<!-- Specify property names.  Create directories -->
	<target name="init">
		<!-- ============================================== -->
		<!--                                                -->
		<!-- You may have to change the location of the WTK -->
		<!--                                                -->
		<!-- ============================================== -->
		<property name="wtk.home" value="C:\jwtk" />
		<property name="emulator" value="emulator.exe" />

		<!-- Directories -->
		<property name="src.dir" value="src" />
		<property name="lib.dir" value="${wtk.home}/lib" />
		<property name="build.dir" value="build/Generic/Microemu/en_US/classes" />
		<property name="test.dir" value="test" />
		<property name="test.mocks.dir" value="test_mocks" />
		<property name="test.build.dir" value="classes_test" />
		<property name="test.dist.dir" value="dist_tests" />
		<property name="dist.dir" value="dist" />
		<property name="docs.dir" value="docs" />
		<property name="reports.dir" location="reports" />

		<property name="wtk.cldc.version" value="1.1" />
		<property name="wtk.midp.version" value="2.0" />

		<property name="wtk.all.enabled" value="true" />



		<mkdir dir="${build.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${test.build.dir}" />
		<mkdir dir="${test.dist.dir}" />

		<path id="midp.classpath">
			<pathelement path="${lib.dir}/midpapi20.jar" />
			<pathelement path="${lib.dir}/cldcapi11.jar" />
		</path>

		<path id="antenna.classpath">
			<pathelement path="lib/antenna-bin-1.2.1-beta.jar" />
		</path>

		<path id="testlib.classpath">
			<pathelement path="lib/jmunit4cldc11-1.2.1.jar" />
			<pathelement path="lib/hammock20_11.jar" />
		</path>
	</target>

	<!-- We need to add Ant tasks for HammockMaker and Antenna. -->
	<target name="taskdefs" depends="init">
		<taskdef name="hammockmaker" classname="com.hammingweight.hammockmaker.HammockMaker" classpath="lib/hammockmaker.jar" />
		<taskdef name="testlistener" classname="jmunit.anttask.TestListener" classpath="lib/jmunit_anttasks-1.2.1.jar" />
		<taskdef name="wtkjad" classname="de.pleumann.antenna.WtkJad" classpathref="antenna.classpath" />
		<taskdef name="wtkpackage" classname="de.pleumann.antenna.WtkPackage" classpathref="antenna.classpath" />
		<taskdef name="wtkrun" classname="de.pleumann.antenna.WtkRun" classpathref="antenna.classpath" />
		<taskdef name="jmunit" classname="jmunit.anttask.cldc11.Jmunit" classpath="lib/jmunit4cldc11-1.2.1.jar:lib/jmunit_anttasks-1.2.1.jar:lib/microemulator.jar:lib/jdom.jar" />

	</target>




	<!-- Create the mock objects we need for JMUnit testing. -->
	<target name="buildmocks" depends="taskdefs">
		<hammockmaker usecldc11="true" dir="${test.mocks.dir}" package="com.hammingweight.objectstreams.mocks" failonerror="true">
			<classpath>
				<pathelement path="${build.dir}" />
			</classpath>
			<mock class="pl.aportuj.aportujmx.comm.Channel" />
		</hammockmaker>
	</target>


	<!-- Build the tests. -->
	<target name="compiletests" depends="buildmocks">
		<javac srcdir="${test.dir}:${test.mocks.dir}" destdir="${test.build.dir}" source="1.2" target="1.1">
			<bootclasspath refid="midp.classpath" />
			<classpath>
				<path refid="testlib.classpath" />
				<pathelement path="${build.dir}" />
			</classpath>
		</javac>
	</target>


	<!-- Package the tests. -->
	<target name="packagetests" depends="compiletests">
		<wtkjad jadfile="${test.dist.dir}/ostests.jad" jarfile="${test.dist.dir}/ostests.jar" name="ostests" vendor="hammingweight.com" version="1.0.0">
			<midlet name="TestRunner" class="pl.aportuj.TestRunner" />
		</wtkjad>
		<wtkpackage jarfile="${test.dist.dir}/ostests.jar" jadfile="${test.dist.dir}/ostests.jad" preverify="false" obfuscate="false">
			<libclasspath>
				<path refid="testlib.classpath" />
			</libclasspath>
			<fileset dir="${build.dir}" />
			<fileset dir="${test.build.dir}" />
		</wtkpackage>
	</target>


	<!-- Run the JMUnit MIDlet. -->
	<target name="test" depends="packagetests">
		<jmunit haltonerror="false" haltonfailure="false" failureproperty="testfailure">
			<formatter type="xml" />
			<classpath>
				<path path="${test.dist.dir}/ostests.jar" />
			</classpath>
			<test name="pl.aportuj.AllTests" todir="${reports.dir}" />
		</jmunit>
	</target>

	<target name="report" depends="test">
		<junitreport todir="${reports.dir}">
			<fileset dir="${reports.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="noframes" todir="${reports.dir}" />
		</junitreport>
	</target>


	<!-- Deploy (package libraries into JARs) -->
	<target name="deploy" depends="test">
		<jar destfile="${dist.dir}/objectstreamsME.jar" basedir="${build.dir}" />
	</target>


	<!-- Clean. -->
	<target name="clean" depends="init">
		<delete dir="${build.dir}" />
		<delete dir="${buildSE.dir}" />
		<delete dir="${dist.dir}" />
		<delete dir="${docs.dir}/api" />
		<delete>
			<fileset dir="${test.mocks.dir}" includes="**/*.java" />
		</delete>
		<delete dir="${test.build.dir}" />
		<delete dir="${test.dist.dir}" />
	</target>
</project>
